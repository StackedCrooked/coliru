<!DOCTYPE html>
<html>
<head>

    <style type="text/css">
        html, body {
            padding: 0;
            margin: 0;
            width: 100%;
            height: 100%;
        }

        #page {
            padding: 0;
            margin: 0;
            width: 100%;
            height: 100%;

        }

        .vbox {
            display: -webkit-box;
            display: -moz-box-box;
            display: -box;

            -webkit-box-orient: vertical;
            -moz-box-orient: vertical;
            -box-orient: vertical;

            -webkit-box-align: stretch;
            -moz-box-align: stretch;
            -box-align: stretch;
        }

        .hbox {
            display: -webkit-box;
            display: -moz-box-box;
            display: -box;

            -webkit-box-orient: horizontal;
            -moz-box-orient: horizontal;
            -box-orient: horizontal;

            -webkit-box-align: stretch;
            -moz-box-align: stretch;
            -box-align: stretch;
        }

        .col {
            height: 100%;
            display: -webkit-box;
            display: -moz-box-box;
            display: -box;
        }

        .row {
            width: 100%;
            display: -webkit-box;
            display: -moz-box-box;
            display: -box;
        }

        #middle {
            display: -webkit-box;
            display: -moz-box-box;
            display: -box;

            -webkit-box-orient: vertical;
            -moz-box-orient: vertical;
            -box-orient: vertical;

            -webkit-box-align: stretch;
            -moz-box-align: stretch;
            -box-align: stretch;

            width: 100%;
            height: 100%;
            overflow: hidden;
        }

        .flex0 {
            -webkit-box-flex: 0.0;
            -moz-box-flex: 0.0;
            -box-flex: 0.0;
        }

        .flex1 {
            -webkit-box-flex: 1.0;
            -moz-box-flex: 1.0;
            -box-flex: 1.0;
        }

        .fake-margin {
            min-height: 10px;

        }

        #editor {
            position: relative;
        }

        #left {
            min-width: 10px;
        }

        #right {
            min-width: 10px;
        }

        #output {
            font-family: monospace;
            overflow: auto;
            height: 200px;
        }

        textarea {
            border-width: medium;
            border-color: #add8e6;

        }

        input:focus, textarea:focus {
            outline: none;
        }
    </style>

</head>
<body>

<div id="page" class="hbox">
    <div id="left" class="col flex0"></div>
    <div id="middle" class="vbox col flex1">
        <div class="fake-margin row flex0"></div>
        <div id="editor" class="row flex1"></div>
        <div class="fake-margin row flex0"></div>
        <textarea id="output" class="row flex0" contenteditable="false" rows="10"></textarea>
        <a id="share" class="row flex0" href="#" onclick="app.share(); return;">Share</a>

        <div class="fake-margin row flex0"></div>
    </div>
    <div id="right" class="col flex0"></div>
</div>
<script src="http://d1n0x3qji82z53.cloudfront.net/src-min-noconflict/ace.js" type="text/javascript"></script>
<script>
    var editor = ace.edit("editor");
    editor.setTheme("ace/theme/textmate");
    editor.getSession().setMode("ace/mode/c_cpp");
    editor.setBehavioursEnabled(false);

    Element.prototype.createChild = function (tagNamePath) {
        "use strict";
        var result = this;
        var tagNames = tagNamePath.split("/");
        for (var i = 0; i < tagNames.length; ++i) {
            var child = document.createElement(tagNames[i]);
            result.appendChild(child);
            result = child;
        }
        return result;
    };

    localStorage.setItem("data", JSON.stringify({
        ids: [],
        bookmarks: {},
        builds: {},
        samples: {
            helloworld: "#include <iostream>\n\nint main()\n{\n\tstd::cout << \"Hello World!\" << std::endl;\n}",
            hellogcc: "#include <iostream>\n\nint main()\n{\n\tstd::cout << \"Hello GCC \" << __VERSION__ << std::endl;\n}"
        }
    }));

    var app = {};

    app.getIds = function () {
        return app.getData().ids;
    };
    app.getBookmarks = function () {
        return app.getData().bookmarks;
    };
    app.getBuilds = function () {
        return app.getData().builds;
    };
    app.getSamples = function () {
        return app.getData().samples;
    };

    app.getAttributeCount = function (obj) {
        var count = 0;
        for (var k in obj) {
            if (obj.hasOwnProperty(k)) {
                ++count;
            }
        }
        return count;

    };
    app.getData = function () {
        return JSON.parse(localStorage.getItem("data"));
    }

    app.output = document.getElementById("output");
    app.waiting = false;

    app.setInitialState = function () {
        if (app.getAttributeCount(app.getBuilds()) == 0) {
            editor.setValue(app.getSamples().helloworld);
        } else {
            var value;
            for (var key in app.getBuilds()) {
                if (app.getBuilds().hasOwnProperty(key)) {
                    value = app.getBuilds()[key];
                }
            }
            editor.setValue(value);
        }
        editor.clearSelection();
    };
    app.setInitialState();

    app.cache = {};

    app.log = function (msg) {
        console.log(msg);
    };

    str = JSON.stringify;

    app.send = function (location, source_code) {


        if (app.cache[source_code] !== undefined) {
            return;
        }

        var httpRequest = new XMLHttpRequest();

        var url = "http://" + window.location.hostname + ":" + window.location.port + '/compile';

        httpRequest.open("PUT", url, true);

        httpRequest.onreadystatechange = function () {
            if (httpRequest.readyState == 4) {
                if (httpRequest.status == 200) {
                    var build_output = httpRequest.responseText;
                    app.cache[source_code] = build_output;
                    app.output.value = build_output;
                    app.waiting = false;
                }
            }
        };
        app.waiting = true;
        httpRequest.send(source_code);
    };


    app.getTime = function () {
        var d = new Date();
        var fill = function (c) {
            c = "" + c;
            return c.length == 2 ? c : "0" + c;
        };
        return fill(d.getHours()) + ":" + fill(d.getMinutes()) + ":" + fill(d.getSeconds());
    };

    app.enterTimeoutLoop = function () {
        app.timeoutLoopImpl();
        window.setTimeout(app.enterTimeoutLoop, 500);
    };


    app.timeoutLoopImpl = function () {
        app.onCompile();
        localStorage.backup = editor.getValue();
    };


    app.onCompile = function () {
        if (app.waiting === false) {
            app.send("compile", editor.getValue());
        }
    };

    app.enterTimeoutLoop();
</script>


</body>
</html>

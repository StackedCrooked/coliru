<!DOCTYPE html>
<html>
<head>

    <style type="text/css">
        html, body {
            padding: 0;
            margin: 0;
            width: 100%;
            height: 100%;
        }

        #container {
            display: -webkit-box;
            display: -moz-box-box;
            display: -box;

            -webkit-box-orient: vertical;
            -moz-box-orient: vertical;
            -box-orient: vertical;
            -webkit-box-align: stretch;
            -moz-box-align: stretch;
            -box-align: stretch;

            width: 100%;
            height: 100%;
            overflow: hidden;
        }

        .row {
            width: 100%;
            display: -webkit-box;
            display: -moz-box-box;
            display: -box;
            -webkit-box-orient: vertical;
            -moz-box-orient: vertical;
            -box-orient: vertical;
        }

        .flex0 {
            -webkit-box-flex: 0.0;
            -moz-box-flex: 0.0;
            -box-flex: 0.0;
        }

        .flex1 {
            -webkit-box-flex: 1.0;
            -moz-box-flex: 1.0;
            -box-flex: 1.0;
        }

        #editor {
            position: relative;
        }

        #links {
            position: relative;
        }

        #output {
            font-family: monospace
        }
    </style>

</head>
<body>

<div id="container">
    <div id="editor" class="row flex1"></div>
    <div id="links" class="row flex0"></div>
    <textarea id="output" class="row flex0" contenteditable="false" rows="10"></textarea>
    <a id="share" class="row flex0" href="#" onclick="app.share(); return;">Share</a>
</div>
<script src="http://d1n0x3qji82z53.cloudfront.net/src-min-noconflict/ace.js" type="text/javascript"></script>
<script>
    var editor = ace.edit("editor");
    editor.setTheme("ace/theme/textmate");
    editor.getSession().setMode("ace/mode/c_cpp");
    editor.setBehavioursEnabled(false);


    var app = {};
    app.output = document.getElementById("output");
    app.waiting = false;

    app.data = {};
    app.ids = {
        "bookmarks": "coliru-bookmarks"
    };

    app.load = function (key, f) {
        //window.remoteStorage.getItem("stacked", function(value, key) { f(value); });
        var result = window.localStorage[key];
        f(result);
    };

    app.save = function (key, value) {
        //window.remoteStorage.setItem(key, value, function(result) { console.log(JSON.stringify(result)) });
        window.localStorage[key] = value;
    };

    app.getSharedLinks = function (f) {
        app.load(app.ids.bookmarks, function (result) {
            if (result !== undefined) {
                f(JSON.parse(result));
            } else {
                f({});
            }

        });
    };

    app.appendSharedLink = function (link) {
        app.getSharedLinks(function (links) {
            links[link.time] = link;
            app.save(app.ids.bookmarks, JSON.stringify(links));
        });
    };

    app.visitSharedLink = function (id) {
        app.getSharedLinks(function (links) {
            var link = links[id];
            editor.setValue(link.src);
            app.output.value = link.output;
        });
    };

    app.addLinkToDOM = function (result) {
        var link = document.getElementById("links").createChild("div/a");
        link.id = result.time;
        link.innerText = result.name;
        link.href = "#";
        link.onclick = function () {
            app.visitSharedLink(result.time);
        };
    };

    app.addLinksToDOM = function () {
        app.getSharedLinks(function (links) {
            for (var id in links) {
                var link = links[id];
                app.addLinkToDOM(link);
            }
        });

    };

    app.share = function () {
        var link = app.lastresult;
        if (link === undefined) {
            return;
        }

        link.name = prompt("Please enter a name: ", "");

        app.appendSharedLink(link);
        app.addLinkToDOM(link);
    };

    if (localStorage.backup !== undefined) {
        editor.setValue(localStorage.backup);
    } else {
        editor.setValue("#include <iostream>\n\nint main()\n{\n\tstd::cout << \"Hello GCC \" << __VERSION__ << std::endl;\n}");
    }

    app.cache = {};
    Element.prototype.createChild = function (tagNamePath) {
        "use strict";
        var result = this;
        var tagNames = tagNamePath.split("/");
        for (var i = 0; i < tagNames.length; ++i) {
            var child = document.createElement(tagNames[i]);
            result.appendChild(child);
            result = child;
        }
        return result;
    };


    app.log = function (msg) {
        console.log(msg);
    };
    app.send = function (location, source_code) {

        var epoch = new Date().valueOf();

        if (app.cache[source_code] !== undefined) {
            app.onReply(app.cache[source_code]);
            app.output.style.color = "black";
            return;
        } else {
            app.output.style.color = "black";
        }

        app.waiting = true;
        app.output.value = app.output.value + "(compiling...)";
        app.output.style.color = "red";

        var httpRequest = new XMLHttpRequest();

        var url = "http://" + window.location.hostname + ":" + window.location.port + '/compile';

        httpRequest.open("PUT", url, true);

        httpRequest.onreadystatechange = function () {
            if (httpRequest.readyState == 4) {
                if (httpRequest.status == 200) {
                    var build_output = httpRequest.responseText;
                    app.cache[source_code] = build_output;
                    app.lastresult = { time: epoch, src: source_code, output: build_output };
                    console.log(JSON.stringify(app.lastresult));
                    app.data[epoch] = JSON.stringify({ src: source_code, output: build_output });

                    app.save(source_code, build_output);
                    app.onReply(httpRequest.responseText);
                    app.waiting = false;
                    app.output.style.color = "black";
                }
            }
        };
        httpRequest.send(source_code);
    };


    app.enterTimeoutLoop = function () {
        app.timeoutLoopImpl();
        window.setTimeout(app.enterTimeoutLoop, 500);
    };


    app.timeoutLoopImpl = function () {

        if (app.waiting === false) {
            var cache = app.cache[editor.getValue()];
            if (cache === undefined) {
                app.onCompile();
            } else if (app.output.value !== cache) {
                app.output.value = cache;
            }
        }

        localStorage.backup = editor.getValue();
    };


    app.onCompile = function () {
        if (app.waiting === false) {
            app.send("compile", editor.getValue());
        }
    };

    app.onReply = function (reply) {
        console.log("reply: " + reply);
        app.output.value = reply;
    };

    app.enterTimeoutLoop();
</script>


</body>
</html>
<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/html">
<head>

    <style type="text/css">
        html, body, textarea {
            position: relative;
            width: 100%; height: 100%;
            margin: 0; padding: 0;
        }

        #page {
            position: relative;
            width: 100%; height: 100%;
            margin: 0; padding: 0;
            overflow: hidden;
        }

        #editor {
            position: relative;
            width: 100%; height: 60%;
            margin-bottom: 1px; padding: 0px;
        }

        #output {
            position: relative;
            height: 30%;
            margin: 0; padding: 0;
            border-style: solid;
            border-color: gray;
        }

        #footer {
            position: relative;
            width: 100%; height: 10%;
            overflow: hidden;
        }

 
        #cloneButton {
            position:absolute; right:0px; top: 0px;
            height: 30px;
            width: 100px;
            margin: 8px;
        }

       
        .ace_cursor { display:none; }
        .ace_cursor-layer { display:none; }

        textarea {
            border-width: 1px;
            border-color: gray;
            border-style: solid;

            outline: 0 !important;
            appearance: none;
            -webkit-appearance: none;
            -moz-appearance: none;
        }

    </style>

</head>
<body>
<div id="page">
    <div id="editor"></div>
    <label for="output"></label><textarea id="output" readonly></textarea>
    <div id="footer">
        <button id="cloneButton">Edit</button>
    </div>
</div>
<script src="//d1n0x3qji82z53.cloudfront.net/src-min-noconflict/ace.js" type="text/javascript"></script>
<script>

var editor = ace.edit("editor");
editor.setTheme("ace/theme/textmate");
editor.getSession().setMode("ace/mode/c_cpp");
editor.setBehavioursEnabled(false);
editor.setReadOnly(true);
editor.clearSelection();


var app = {};
app.id = "" + window.location.href.split("?")[1].split('=')[1];
app.editor = editor;
app.output = document.getElementById("output");
app.output.readOnly = true;
app.output.data = "Fetching data....";


app.send = function (location, post_data, f) {
    var httpRequest = new XMLHttpRequest();
    var url = "http://" + window.location.hostname + ":" + window.location.port + '/' + location;
    httpRequest.open("PUT", url, true);
    httpRequest.onreadystatechange = function () {
        if (httpRequest.readyState == 4) {
            if (httpRequest.status == 200) {
                f(httpRequest.responseText.trim());
            }
        }
    };
    httpRequest.send(post_data);
};



app.send(app.id, "", function(response) {
    var parts = response.split('\t');
    if (parts.length > 0) {
        app.editor.setValue(parts[0].replace(/\\t/, "\t"));
    }
    if (parts.length > 1) {
        app.output.value = parts[1].replace(/\\t/, "\t");
    }

    window.setTimeout(function() {
        var ace_lines = document.getElementsByClassName("ace_line");
        for (var i = 0; i !== ace_lines.length; ++i) {
            ace_lines[i].style.color = "inherit";
        }
        var output_lines = app.output.value.split(/\n/);
        for (var i = 0; i != output_lines.length; ++i) {
            try {
                var line = output_lines[i];
                if (line.search(/^main.cpp:\d+:\d+/) !== -1) {
                    var lineno = parseInt(line.split(":")[1]);
                    ace_lines[lineno - 1].style.color = "red";
                }
            }
            catch (e) {
                console.log(JSON.stringify(e));
            }
        }
    }, 100);


    app.editor.clearSelection();
    app.editor.scrollToRow(0);
});

app.goBack = function () {
    localStorage.setItem("sourceCode", editor.getValue());
    window.location.href = "/";
    //history.go(-1);
};

document.getElementById("cloneButton").onclick = app.goBack;


</script>
</body>
</html>

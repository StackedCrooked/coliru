<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/html">
<head>

    <style type="text/css">
        html, body {
            position: relative;
            margin: 0;
            width: 100%;
            height: 100%;
        }

        #page {
            position: relative;
            margin: 0;
            padding: 0;
            width: 100%;
            height: 100%;
            font-family: monospace;
        }

        #editor {
            position: relative;
            margin: 0;
            padding: 0;
            width: 100%;
            height: 50%;
        }

        #output {
            position: relative;
            margin: 0;
            padding: 0;
            width: 100%;
            height: 30%;
            border: 0 ridge;
            resize: none;
            outline: 0 !important;
        }

        #footer {
            position: relative;
            margin: 0;
            padding: 0;
            height: 20px;
            text-align: center;
            vertical-align: middle;
        }

        #autocompile {
            position: relative;
            margin: 0;
            padding: 0;
            vertical-align: middle
        }

        #post {
            position: relative;
            margin: 0;
            padding: 0;
            position: relative;
            display: none;
            width: 100px;
            height: 30px;
        }

    </style>

</head>
<body>
<div id="page">
    <div id="editor"></div>
    <hr/>
    <label for="output"></label><textarea id="output" readonly></textarea>
    <hr/>
    <div id="footer">
        <label>
            <input id="autocompile" onclick="app.editor.focus();" type="checkbox">&nbspCompile automatically</input>
        </label>
        <button id="post" onclick="app.postSample();">Post Sample!</button>
    </div>
</div>
<script src="http://stacked-crooked.com/md5-min.js"></script>
<script src="http://d1n0x3qji82z53.cloudfront.net/src-min-noconflict/ace.js" type="text/javascript"></script>
<script>
    var editor = ace.edit("editor");
    editor.setTheme("ace/theme/textmate");
    editor.getSession().setMode("ace/mode/c_cpp");
    editor.setBehavioursEnabled(false);

    console.log("test: " + hex_md5("test"));

    Element.prototype.createChild = function (tagNamePath) {
        "use strict";
        var result = this;
        var tagNames = tagNamePath.split("/");
        for (var i = 0; i < tagNames.length; ++i) {
            var child = document.createElement(tagNames[i]);
            result.appendChild(child);
            result = child;
        }
        return result;
    };


    var app = {
        samples: {
            "Hello World!": "#include <iostream>\n#include <thread>\n\nint main()\n{\n    std::cout << \"Hello GCC \" << __VERSION__ << \"!\" << std::endl;\n    std::thread t([](){ std::cout << \"Hello Thread!\"; });\n    t.join();\n}"
        },
        elements: {
            editor: document.getElementById("editor"),
            output: document.getElementById("output")
        }
    };

    app.elements.output.scrollTop = app.elements.output.scrollHeight;

    app.editor = editor;

    app.postSample = function () {
        var url = "http://" + window.location.hostname + ":" + window.location.port + "/archive?id=" + app.lastResult;
        window.open(url, '_blank');
    };

    app.http_get = function (url) {
        var x = new XMLHttpRequest();
        x.open("GET", url, false);
        x.send(null);
        return x.responseText;
    };


    String.prototype.trim = function () {
        return this.replace(/^\s+|\s+$/g, "");
    };

    if (localStorage.getItem("sourceCode") === undefined) {
        localStorage.setItem("sourceCode", app.samples["Hello World!"]);
    }
    editor.setValue(localStorage.getItem("sourceCode"));

    document.getElementById("autocompile").checked = true;

    app.lastChange = 0;

    document.getElementById("editor").onkeyup = function () {
        app.lastChange = new Date().getTime();
        localStorage.setItem("sourceCode", editor.getValue());

    };

    app.waiting = false;
    document.getElementById("post").disabled = false;


    app.send = function (location, source_code, f) {
        var httpRequest = new XMLHttpRequest();
        var url = "http://" + window.location.hostname + ":" + window.location.port + '/compile';
        httpRequest.open("PUT", url, true);
        httpRequest.onreadystatechange = function () {
            if (httpRequest.readyState == 4) {
                if (httpRequest.status == 200) {
                    app.waiting = false;
                    document.getElementById("post").disabled = false;
                    app.lastResult = httpRequest.responseText.trim();
                    //f({input: source_code, output: app.http_get("http://" + window.location.hostname + ":" + window.location.port + "/Archive/" + app.lastResult + "/output.txt")});
                    f({input: source_code, output: app.lastResult});
                }
            }
        };
        app.waiting = true;
        document.getElementById("post").disabled = true;
        httpRequest.send(source_code);
    };


    app.previousValue = "";

    app.enterTimeoutLoop = function () {
        app.timeoutLoopImpl();
        window.setTimeout(app.enterTimeoutLoop, 250);
    };


    app.setOutput = function (value) {
        document.getElementById("output").value = value;
    };

    app.timeoutLoopImpl = function () {
        localStorage.setItem("sourceCode", editor.getValue());
        var cachedOutput = localStorage.getItem(localStorage.getItem("sourceCode"));
        if (cachedOutput !== undefined && cachedOutput !== null) {
            document.getElementById("output").value = cachedOutput;
            return;
        }
        var time = (new Date().getTime());
        if (app.waiting === false && time - app.lastChange >= 1000 && editor.getValue() != app.previousValue && document.getElementById("autocompile").checked === true) {
            document.getElementById("output").value = document.getElementById("output").value + "\n(compiling)";
            app.previousValue = document.getElementById("output").value;
            app.sentData = localStorage.getItem("sourceCode");
            app.send("compile", app.sentData, function (result) {
                app.setOutput(result.output);
                localStorage.setItem(app.sentData, result.output);
                app.previousValue = app.sentData;
            });
        }
    };


    window.onload = function () {
        editor.setValue(localStorage.getItem("sourceCode"));
        app.previousValue = "";
        editor.clearSelection();
        app.enterTimeoutLoop();
    };
</script>


</body>
</html>

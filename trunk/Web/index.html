<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.0 Frameset//EN">
<html>
<head>
    <title>Coliru</title>
</head>
<script type="text/javascript" language="javascript">

    var app = { };
    app.elements = {};

    app.samples = {
        "Hello World!": "#include <iostream>\n#include <thread>\n\nint main()\n{\n    std::cout << \"Hello GCC \" << __VERSION__ << \"!\" << std::endl;\n    std::thread t([](){ std::cout << \"Hello Thread!\"; });\n    t.join();\n}"
    };

    document.write('<frameset rows="100%, 200" border="4" >');
    document.write(' <frame src="frame-top.html" name="top" scrolling="no" frameborder="1" />');
    document.write(' <frame src="frame-bottom.html" name="bottom" scrolling="no" frameborder="1" />');
    document.write('</frameset>');


    window.onload = function () {

        String.prototype.trim = function () {
            return this.replace(/^\s+|\s+$/g, "");
        };

        var sourceCode = localStorage.getItem("sourceCode");
        if (sourceCode === null || sourceCode === "") {
            localStorage.setItem("sourceCode", app.samples["Hello World!"]);
        }
        app.elements.editor.setValue(localStorage.getItem("sourceCode"));

        app.enableUI = function(value) {
            app.elements.compileButton.disabled = !value;;
            app.elements.postButton.disabled = !value;;
            app.elements.editor.setReadOnly(!value);
        };

        app.send = function (location, source_code, f) {
            app.enableUI(false);
            localStorage.setItem("sourceCode", app.elements.editor.getValue());
            var httpRequest = new XMLHttpRequest();
            httpRequest.open("PUT", "http://" + window.location.hostname + ":" + window.location.port + '/' + location, true);
            httpRequest.onreadystatechange = function () {
                if (httpRequest.readyState == 4) {
                    if (httpRequest.status == 200) {
                        app.enableUI(true);
                        app.lastResult = httpRequest.responseText.trim();
                        f({input: source_code, output: app.lastResult});
                    }
                }
            };
            httpRequest.send(source_code);
        };


        app.previousValue = "";

        app.compileNow = function () {
            app.send("compile", app.elements.editor.getValue(), function (obj) {
                app.elements.output.value = obj.output;
                window.setTimeout(function() {
                    var ace_lines = app.editorDocument.getElementsByClassName("ace_line");
                    for (var i = 0; i !== ace_lines.length; ++i) {
                        ace_lines[i].style.color = "inherit";
                    }
                    var output_lines = app.elements.output.value.split(/\n/);
                    for (var i = 0; i != output_lines.length; ++i) {
                        try {
                            var line = output_lines[i];
                            if (line.search(/^main.cpp:\d+:\d+/) !== -1) {
                                var lineno = parseInt(line.split(":")[1]);
                                ace_lines[lineno - 1].style.color = "red";
                            }
                        }
                        catch (e) {
                            console.log(JSON.stringify(e));
                        }
                    }
                }, 100);
            });
        };

        app.postSample = function () {
            app.send("share", app.elements.editor.getValue(), function (obj) {
                window.open("http://" + window.location.hostname + ":" + window.location.port + "/view?id=" + obj.output, '_self');
            });
        };

        app.previousValue = "";
        app.elements.editor.clearSelection();
    };
</script>
</html>
